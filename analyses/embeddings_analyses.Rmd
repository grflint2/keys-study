---
title: "R Notebook"
output: html_notebook
---


```{r}
rm(list = ls())

library(tidyverse)
library(ggplot2)
library(data.table)
library(lme4)
library(lmerTest)
```

# Distance to man and woman

## Load and clean data

Cosine distances:
```{r}
dat.en = read.csv('../data/embeddings/control/en_embeddings_control.csv') 
dat.es = read.csv('../data/embeddings/control/es_embeddings_control.csv')
dat.de = read.csv('../data/embeddings/control/de_embeddings_control.csv')
dat = rbind(dat.en, dat.es, dat.de) %>% unique()
dat = dat %>% 
  mutate(TARGET.CONCEPT=ifelse(TARGET.WORD %in% c("woman", "Frau", "mujer"), "woman", "man"))
#manual adjustment
dat = dat %>% filter(REFERENCE.WORD!='macha')
dat.nouns = dat %>% 
  filter(REFERENCE.GROUP=='nouns') %>% 
  filter(TARGET.GROUP=='genders') 
dat.adjectives = dat %>% filter(REFERENCE.GROUP=='adjectives') %>% filter(TARGET.GROUP=='genders')
```

Noun info:
```{r}
noun_info = read.csv('../materials/matchings/reference/matchings_nouns.csv')
noun_info = noun_info %>% rename(REFERENCE.CONCEPT=translation, NOUN.GROUP=Group) %>%
  pivot_longer(!c(REFERENCE.CONCEPT, NOUN.GROUP), names_to = "LANGUAGE", values_to = "REFERENCE.WORD") %>%
  mutate(NOUN.GROUP=ifelse(NOUN.GROUP=="Spanish Masculine", "de-F.es-M", "de-M.es-F"))
```

Adjective info (spanish grammatical gender):
```{r}
adjective_info.es = rbind(read.csv('../materials/adjectives/es-adjectives-info/es_feminine_group_adjectives_info.csv'),
                          read.csv('../materials/adjectives/es-adjectives-info/es_masculine_group_adjectives_info.csv'))

dat.adjectives = dat.adjectives %>% 
  mutate(GRAMMATICAL.FORM = ifelse(LANGUAGE %in% c('en', 'de'), 'neuter',
                                  ifelse(REFERENCE.WORD %in% adjective_info.es$adjective.masc.form, 'masculine',
                                  ifelse(REFERENCE.WORD %in% adjective_info.es$adjective.fem.form, 'feminine', 'neuter'))))
```

Combine:
```{r}
dat.nouns = noun_info %>% merge(dat.nouns)
```

## NOUNS

### Stats

Contrasts:
```{r}
dat.nouns$REFERENCE.CONCEPT = as.factor(dat.nouns$REFERENCE.CONCEPT)   # random effect, reference level doesn't matter
dat.nouns$TARGET.CONCEPT = as.factor(dat.nouns$TARGET.CONCEPT)
contrasts(dat.nouns$TARGET.CONCEPT) = contr.sum(2)    # sum coding, mean between man and woman is the reference level
colnames(attr(dat.nouns$TARGET.CONCEPT, "contrasts")) = c("man-woman")
dat.nouns$LANGUAGE = factor(dat.nouns$LANGUAGE, levels=c("en", "es", "de"))   # dummy coding, en is the reference level
dat.nouns$NOUN.GROUP = as.factor(dat.nouns$NOUN.GROUP)
contrasts(dat.nouns$NOUN.GROUP) = contr.sum(2)    # sum coding, mean between man and woman is the reference level
colnames(attr(dat.nouns$NOUN.GROUP, "contrasts")) = c("groupdiff")
```

Model:
```{r}
m = lmer(COSINE.SIMILARITY~LANGUAGE*TARGET.CONCEPT*NOUN.GROUP+(1+LANGUAGE|REFERENCE.CONCEPT), data=dat.nouns, REML=FALSE)
summary(m)
```

### Plot

```{r}
ggplot(data=dat.nouns, mapping=aes(x=NOUN.GROUP, y=COSINE.SIMILARITY, fill=TARGET.CONCEPT))+
  facet_wrap(~LANGUAGE)+
  stat_summary(geom='col', fun='mean',
               width=0.8, position='dodge')+
  stat_summary(geom='errorbar', fun.data='mean_se',
               color = 'black', size = 0.8, width=0, position=position_dodge(width=0.8))+
  geom_point(position=position_jitterdodge(jitter.width=0.2, jitter.height=0,
                                           dodge.width = 0.8), 
             size=1, alpha=0.5, shape=21, stroke=.5)+
  geom_hline(yintercept=0)+
  theme_classic()
```
## ADJECTIVES

### Stats

Contrasts:
```{r}
dat.adjectives$REFERENCE.WORD = as.factor(dat.adjectives$REFERENCE.WORD)   # random effect, reference level doesn't matter
dat.adjectives$TARGET.CONCEPT = as.factor(dat.adjectives$TARGET.CONCEPT)
contrasts(dat.adjectives$TARGET.CONCEPT) = contr.sum(2)    # sum coding, mean between man and woman is the reference level
colnames(attr(dat.adjectives$TARGET.CONCEPT, "contrasts")) = c("man-woman")
dat.adjectives$LANGUAGE = factor(dat.adjectives$LANGUAGE, levels=c("en", "es", "de"))   # dummy coding, en is the reference level
dat.adjectives$REFERENCE.ASSOCIATION = as.factor(dat.adjectives$REFERENCE.ASSOCIATION)
contrasts(dat.adjectives$REFERENCE.ASSOCIATION) = contr.sum(2)    # sum coding, mean between man and woman is the reference level
colnames(attr(dat.adjectives$REFERENCE.ASSOCIATION, "contrasts")) = c("man-woman")
dat.adjectives$GRAMMATICAL.FORM = factor(dat.adjectives$GRAMMATICAL.FORM, levels=c("neuter", "masculine", "feminine"))
```

Model:
```{r}
m = lmer(COSINE.SIMILARITY~LANGUAGE*TARGET.CONCEPT*REFERENCE.ASSOCIATION+GRAMMATICAL.FORM:TARGET.CONCEPT+(1|REFERENCE.WORD), data=dat.adjectives, REML=FALSE)
summary(m)
```

### Plot

```{r}
ggplot(data=dat.adjectives, mapping=aes(x=REFERENCE.ASSOCIATION, y=COSINE.SIMILARITY, fill=TARGET.CONCEPT))+
  facet_wrap(~LANGUAGE)+
  stat_summary(geom='col', fun='mean',
               width=0.8, position='dodge')+
  stat_summary(geom='errorbar', fun.data='mean_se',
               color = 'black', size = 0.8, width=0, position=position_dodge(width=0.8))+
  geom_point(position=position_jitterdodge(jitter.width=0.2, jitter.height=0,
                                           dodge.width = 0.8), 
             size=1, alpha=0.5, shape=21, stroke=.5)+
  geom_hline(yintercept=0)+
  theme_classic()
```


# Adjectives and gender association ratings

## Load and clean gender association ratings
```{r}
dat.ratings.en = read.csv('../data/adjective-ratings/processed/en_summary_by_adjective.csv')
dat.ratings.es = read.csv('../data/adjective-ratings/processed/es_summary_by_adjective.csv')
dat.ratings.de = read.csv('../data/adjective-ratings/processed/de_summary_by_adjective.csv')
dat.ratings = rbind(dat.ratings.en %>% mutate("LANGUAGE"='en'), 
                    dat.ratings.es %>% mutate("LANGUAGE"='es'), 
                    dat.ratings.de %>% mutate("LANGUAGE"='de')) %>% 
  unique() %>%
  merge(dat.adjectives, by.x=c("LANGUAGE", "Adjective"), by.y=c("LANGUAGE", "REFERENCE.WORD"))

```

## Only keep adjectives that can describe a person
```{r}
threshold = 1.6
dat.ratings.excluded = dat.ratings %>% filter(meanPerson>1.6)
dat.ratings = dat.ratings %>% filter(meanPerson<=1.6)
warning(paste("Excluding", nrow(dat.ratings.excluded), "adjectives that cannot be used to describe a person"))
```

## By group

### Model

Contrasts:
```{r}
dat.ratings$Adjective = as.factor(dat.ratings$Adjective)   # random effect, reference level doesn't matter
dat.ratings$TARGET.CONCEPT = as.factor(dat.ratings$TARGET.CONCEPT)
contrasts(dat.ratings$TARGET.CONCEPT) = contr.sum(2)    # sum coding, mean between man and woman is the reference level
colnames(attr(dat.ratings$TARGET.CONCEPT, "contrasts")) = c("man-woman")
dat.ratings$LANGUAGE = factor(dat.ratings$LANGUAGE, levels=c("en", "es", "de"))   # dummy coding, en is the reference level
dat.ratings$REFERENCE.ASSOCIATION = as.factor(dat.ratings$REFERENCE.ASSOCIATION)
contrasts(dat.ratings$REFERENCE.ASSOCIATION) = contr.sum(2)    # sum coding, mean between man and woman is the reference level
colnames(attr(dat.ratings$REFERENCE.ASSOCIATION, "contrasts")) = c("man-woman")
```

Model:
```{r}
m = lmer(meanAssociation~LANGUAGE*REFERENCE.ASSOCIATION+(1|Adjective), data=dat.ratings, REML=FALSE)
summary(m)
```

### Plot

```{r}
ggplot(data=dat.ratings, mapping=aes(x=REFERENCE.ASSOCIATION, y=meanAssociation))+
  facet_wrap(~LANGUAGE)+
  stat_summary(geom='col', fun='mean',
               width=0.8)+
  stat_summary(geom='errorbar', fun.data='mean_se',
               color = 'black', size = 0.8, width=0)+
  geom_point(position=position_jitter(width=0.2, height=0), 
             size=1, alpha=0.5, shape=21, stroke=.5)+
  geom_hline(yintercept=0)+
  theme_classic()
```


## No groups, all adjectives

### Stats

```{r}
dat.wider = dat.ratings %>%
  pivot_wider(id_cols = c(LANGUAGE, Adjective, meanAssociation), names_from=TARGET.CONCEPT, values_from=COSINE.SIMILARITY)
```

Contrasts:
```{r}
dat.wider$LANGUAGE = factor(dat.wider$LANGUAGE, levels=c("en", "es", "de")) 
dat.wider$Adjective = as.factor(dat.wider$Adjective)
```

Model:
```{r}
m = lmer(meanAssociation~LANGUAGE + LANGUAGE:scale(man) + LANGUAGE:scale(woman) + (1|Adjective), data=dat.wider, control=lmerControl(optimizer = "bobyqa", optCtrl=list(maxfun=2e9)))
summary(m)
```

### Plot
```{r}
ggplot(data=dat.ratings, mapping=aes(x=meanAssociation, y=COSINE.SIMILARITY))+
  facet_wrap(TARGET.CONCEPT~LANGUAGE)+
  geom_point()+
  theme_classic()
```

















# Distance between nouns and adjectives

## Load
```{r}
dat.crit.en = read.csv('../data/embeddings/experimental/en_embeddings_experimental.csv')
dat.crit.es = read.csv('../data/embeddings/experimental/es_embeddings_experimental.csv')
dat.crit.de = read.csv('../data/embeddings/experimental/de_embeddings_experimental.csv')
dat.crit = rbind(dat.crit.en, dat.crit.es, dat.crit.de) %>% unique()

dat.crit = dat.crit %>% filter(ADJECTIVE!='macha')

# add noun group info
dat.crit = noun_info %>% merge(dat.crit, by.x=c('LANGUAGE', 'REFERENCE.WORD'), by.y=c('LANGUAGE', 'NOUN'))
```

Only include adjectives that describe people
```{r}
dat.crit = dat.crit %>% filter(ADJECTIVE %in% dat.wider$Adjective)
```

## Stats

Contrasts:
```{r}
dat.crit$REFERENCE.CONCEPT = as.factor(dat.crit$REFERENCE.CONCEPT)   # random effect, reference level doesn't matter
dat.crit$ADJECTIVE = as.factor(dat.crit$ADJECTIVE)   # random effect, reference level doesn't matter
dat.crit$GENDER.ASSOCIATION.OF.ADJECTIVE = as.factor(dat.crit$GENDER.ASSOCIATION.OF.ADJECTIVE)
contrasts(dat.crit$GENDER.ASSOCIATION.OF.ADJECTIVE) = contr.sum(2)    # sum coding, mean between man and woman is the reference level
colnames(attr(dat.crit$GENDER.ASSOCIATION.OF.ADJECTIVE, "contrasts")) = c("masc-fem")
dat.crit$LANGUAGE = factor(dat.crit$LANGUAGE, levels=c("en", "es", "de"))   # dummy coding, en is the reference level
dat.crit$NOUN.GROUP = as.factor(dat.crit$NOUN.GROUP)
contrasts(dat.crit$NOUN.GROUP) = contr.sum(2)    # sum coding, mean between man and woman is the reference level
colnames(attr(dat.crit$NOUN.GROUP, "contrasts")) = c("groupdiff")
```

Model:
```{r}
m = lmer(COSINE.SIMILARITY~LANGUAGE*NOUN.GROUP*GENDER.ASSOCIATION.OF.ADJECTIVE+(1+LANGUAGE|REFERENCE.CONCEPT)+(1|ADJECTIVE), data=dat.crit, REML=FALSE)
summary(m)
```

## Plot

```{r}

dat.crit.by_adjective = dat.crit %>%
  group_by(ADJECTIVE,LANGUAGE,NOUN.GROUP,GENDER.ASSOCIATION.OF.ADJECTIVE) %>% summarize(COSINE.SIMILARITY=mean(COSINE.SIMILARITY))
dat.crit.by_noun = dat.crit %>%
  group_by(REFERENCE.WORD,LANGUAGE,NOUN.GROUP,GENDER.ASSOCIATION.OF.ADJECTIVE) %>% summarize(COSINE.SIMILARITY=mean(COSINE.SIMILARITY))

ggplot(data=dat.crit.by_noun, mapping=aes(x=NOUN.GROUP, y=COSINE.SIMILARITY, fill=GENDER.ASSOCIATION.OF.ADJECTIVE))+
  facet_wrap(~LANGUAGE)+
  stat_summary(geom='col', fun='mean',
               width=0.8, position='dodge')+
  stat_summary(geom='errorbar', fun.data='mean_se',
               color = 'black', size = 0.8, width=0, position=position_dodge(width=0.8))+
  geom_point(position=position_jitterdodge(jitter.width=0.2, jitter.height=0,
                                           dodge.width = 0.8), 
             size=.5, alpha=0.5, shape=21, stroke=.5)+
  geom_hline(yintercept=0)+
  theme_classic()
```


## Repeat but now only with nouns & adjectives used in the matching experiment

```{r}
matchings.en = read.csv('../materials/matchings/stimulus/en_matchings_stimulus.csv')
matchings.es = read.csv('../materials/matchings/stimulus/es_matchings_stimulus.csv')
matchings.de = read.csv('../materials/matchings/stimulus/de_matchings_stimulus.csv')

dat.crit.en.matchings = dat.crit.en %>%
  filter(NOUN %in% matchings.en$noun) %>%
  filter((ADJECTIVE %in% matchings.en$masculine_adjective) | (ADJECTIVE %in% matchings.en$feminine_adjective))

dat.crit.es.matchings = dat.crit.es %>%
  filter(NOUN %in% matchings.es$noun) %>%
  filter((ADJECTIVE %in% matchings.es$masculine_adjective) | (ADJECTIVE %in% matchings.es$feminine_adjective))

dat.crit.de.matchings = dat.crit.de %>%
  filter(NOUN %in% matchings.de$noun) %>%
  filter((ADJECTIVE %in% matchings.de$masculine_adjective) | (ADJECTIVE %in% matchings.de$feminine_adjective))

dat.crit.matchings = rbind(dat.crit.en.matchings, dat.crit.es.matchings, dat.crit.de.matchings)

# TODO fix mismatches in adjectives
write.csv(dat.crit.matchings, "../data/embeddings/experimental/all_embeddings_experimental_matchings.csv",
          row.names=FALSE)
```




